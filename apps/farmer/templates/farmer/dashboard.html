{% extends 'farmer/base.html' %}

{% block base_title %}Dashboard{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}
    {% if selected_farm %}
        {{ selected_farm.farm_name }} - Soil Monitoring Dashboard
    {% else %}
        Please add a farm to get started
    {% endif %}
{% endblock %}

{% block content %}
{% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
        <span class="block sm:inline">{{ error }}</span>
    </div>
{% else %}
    <!-- Farm Selector -->
    {% if farms.count > 1 %}
    <div class="mb-6">
        <label for="farm-select" class="block text-sm font-medium text-gray-700 mb-2">Select Farm</label>
        <select id="farm-select" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
            {% for farm in farms %}
                <option value="{{ farm.id }}" {% if farm.id == selected_farm.id %}selected{% endif %}>
                    {{ farm.farm_name }}
                </option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Temperature Card -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4  hover:shadow-lg transition-shadow">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-green-500/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-thermometer-half text-green-500 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Temperature</p>
                    <p class="text-2xl font-bold text-gray-900">{{ temperature }}Â°C</p>
                    <p class="text-xs text-gray-600">Current Reading</p>
                </div>
            </div>
        </div>

        <!-- Humidity Card -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4  hover:shadow-lg transition-shadow">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-blue-500/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-cloud text-blue-500 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Humidity</p>
                    <p class="text-2xl font-bold text-gray-900">{{ humidity }}%</p>
                    <p class="text-xs text-gray-600">Current Reading</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Soil Moisture Prediction System Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- About the System -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-brain text-primary text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">How Our Predictions Work</h3>
            </div>
            <div class="prose prose-sm text-gray-600">
                <p class="mb-4">Our advanced AI-powered soil moisture prediction system uses multiple data points to forecast soil conditions and provide tailored recommendations:</p>
                <ul class="list-disc list-inside space-y-2 mb-4">
                    <li><span class="font-medium text-gray-700">Real-time Sensors:</span> Continuous monitoring of soil moisture, temperature, and humidity</li>
                    <li><span class="font-medium text-gray-700">Weather Integration:</span> Local weather forecasts and historical patterns</li>
                    <li><span class="font-medium text-gray-700">Crop Data:</span> Specific requirements for your crops and growth stages</li>
                    <li><span class="font-medium text-gray-700">Machine Learning:</span> Advanced algorithms trained on extensive agricultural datasets</li>
                </ul>
                <div class="bg-green-50 rounded-lg p-4 mb-4">
                    <p class="text-sm text-green-800"><i class="fas fa-lightbulb text-green-600 mr-2"></i>Our predictions are updated every 6 hours to maintain accuracy and reliability.</p>
                </div>
            </div>
        </div>

        <!-- How Recommendations Work -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-clipboard-list text-blue-500 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Smart Recommendations</h3>
            </div>
            <div class="prose prose-sm text-gray-600">
                <p class="mb-4">Our recommendation engine analyzes multiple factors to provide actionable insights:</p>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 mb-2">Input Factors</h4>
                        <ul class="text-blue-800 text-sm space-y-1">
                            <li><i class="fas fa-check-circle mr-1"></i>Soil moisture levels</li>
                            <li><i class="fas fa-check-circle mr-1"></i>Weather forecasts</li>
                            <li><i class="fas fa-check-circle mr-1"></i>Crop water needs</li>
                            <li><i class="fas fa-check-circle mr-1"></i>Growth stage</li>
                        </ul>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h4 class="font-medium text-purple-900 mb-2">Output Actions</h4>
                        <ul class="text-purple-800 text-sm space-y-1">
                            <li><i class="fas fa-arrow-right mr-1"></i>Irrigation timing</li>
                            <li><i class="fas fa-arrow-right mr-1"></i>Water quantity</li>
                            <li><i class="fas fa-arrow-right mr-1"></i>Resource optimization</li>
                            <li><i class="fas fa-arrow-right mr-1"></i>Risk prevention</li>
                        </ul>
                    </div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4">
                    <p class="text-sm text-yellow-800"><i class="fas fa-exclamation-circle text-yellow-600 mr-2"></i>Recommendations are customized based on your farm's specific conditions and historical performance.</p>
                </div>
            </div>
        </div>
    </div>

    {% if prediction_available %}
    <!-- Current Predictions Section -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Predictions & Recommendations</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <canvas id="predictionChart" width="400" height="200"></canvas>
            </div>
            <div>
                <h4 class="text-md font-semibold text-gray-900 mb-4">AI-Generated Recommendations</h4>
                {% if recommendation %}
                    <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-robot text-green-600 text-xl mr-3"></i>
                            <h5 class="font-medium text-green-900">System Suggestion</h5>
                        </div>
                        <p class="text-green-700">{{ recommendation }}</p>
                    </div>
                {% else %}
                    <div class="bg-gray-50 border-l-4 border-gray-500 p-6 rounded-lg">
                        <p class="text-gray-600">Gathering more data to generate personalized recommendations...</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Farm selector handler
    const farmSelect = document.getElementById('farm-select');
    if (farmSelect) {
        farmSelect.addEventListener('change', function() {
            window.location.href = `?farm_id=${this.value}`;
        });
    }

    {% if prediction_available %}
    // Prediction chart
    const predCtx = document.getElementById('predictionChart').getContext('2d');
    new Chart(predCtx, {
        type: 'line',
        data: {
            labels: {{ prediction_dates|safe }},
            datasets: [{
                label: 'Actual Moisture',
                data: {{ moisture_values|safe }},
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: false
            },
            {
                label: 'Predicted Moisture',
                data: {{ moisture_predictions|safe }},
                borderColor: '#6366F1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
                fill: false,
                borderDash: [5, 5]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                title: {
                    display: true,
                    text: 'Soil Moisture Prediction Analysis',
                    font: {
                        size: 16
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Moisture Level (%)'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Timeline'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}

