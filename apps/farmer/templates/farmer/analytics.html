{% extends 'farmer/base.html' %}

{% block base_title %}Analytics{% endblock %}

{% block page_title %}Analytics Dashboard{% endblock %}
{% block page_subtitle %}Detailed insights and trends for your farm using ML predictions{% endblock %}

{% block content %}
<!-- Farm and Algorithm Selection -->
<div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <form id="selectionForm" class="flex items-center space-x-4">
        <div class="flex-grow">
            <label for="farmSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Farm</label>
            <select id="farmSelect" name="farm_id" class="form-select w-full rounded-lg border-gray-300 focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                {% for farm in farms %}
                    <option value="{{ farm.id }}" {% if farm.id == selected_farm.id %}selected{% endif %}>
                        {{ farm.farm_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="flex-grow">
            <label for="algorithmSelect" class="block text-sm font-medium text-gray-700 mb-2">Prediction Algorithm</label>
            <select id="algorithmSelect" name="algorithm" class="form-select w-full rounded-lg border-gray-300 focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                {% for algo in available_algorithms %}
                    <option value="{{ algo }}" {% if algo == selected_algorithm %}selected{% endif %}>
                        {{ algo|title }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Weekly Analysis -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Weekly Moisture Predictions</h3>
        <canvas id="weeklyChart" width="400" height="300"></canvas>
    </div>

    <!-- Monthly Trends -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Temperature & Humidity Trends</h3>
        <canvas id="monthlyChart" width="400" height="300"></canvas>
    </div>
</div>

<!-- Detailed Statistics -->
<div class="bg-white rounded-xl shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Detailed Statistics (ML Predictions)</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <p class="text-3xl font-bold text-primary">{{ avg_moisture }}%</p>
            <p class="text-sm text-gray-600">Average Predicted Moisture</p>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <p class="text-3xl font-bold text-green-500">{{ irrigation_events }}</p>
            <p class="text-sm text-gray-600">Irrigation Events</p>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <p class="text-3xl font-bold text-blue-500">{{ water_saved }}L</p>
            <p class="text-sm text-gray-600">Water Saved (per day)</p>
        </div>
    </div>
</div>

<!-- Weather Impact -->
<div class="bg-white rounded-xl shadow-md p-6 mt-8">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Weather Impact Analysis</h3>
    <div class="space-y-4">
        <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-cloud-rain text-blue-500 text-xl mr-3"></i>
                <div>
                    <p class="text-sm font-medium text-blue-900">Rainfall Effect</p>
                    <p class="text-xs text-blue-700">Impact on moisture levels</p>
                </div>
            </div>
            <span class="text-sm font-medium text-blue-900">+{{ rainfall_effect }}%</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-sun text-yellow-500 text-xl mr-3"></i>
                <div>
                    <p class="text-sm font-medium text-yellow-900">Temperature Effect</p>
                    <p class="text-xs text-yellow-700">Impact on evaporation</p>
                </div>
            </div>
            <span class="text-sm font-medium text-yellow-900">-{{ temperature_effect }}%</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-wind text-green-500 text-xl mr-3"></i>
                <div>
                    <p class="text-sm font-medium text-green-900">Wind Effect</p>
                    <p class="text-xs text-green-700">Impact on moisture</p>
                </div>
            </div>
            <span class="text-sm font-medium text-green-900">-{{ wind_effect }}%</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle form changes
    const form = document.getElementById('selectionForm');
    const farmSelect = document.getElementById('farmSelect');
    const algorithmSelect = document.getElementById('algorithmSelect');

    farmSelect.addEventListener('change', updateView);
    algorithmSelect.addEventListener('change', updateView);

    function updateView() {
        const params = new URLSearchParams();
        params.set('farm_id', farmSelect.value);
        params.set('algorithm', algorithmSelect.value);
        window.location.href = `?${params.toString()}`;
    }

    // Weekly Moisture Chart
    const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
    new Chart(weeklyCtx, {
        type: 'bar',
        data: {
            labels: {{ dates|safe }},
            datasets: [{
                label: 'Predicted Moisture',
                data: {{ moisture_values|safe }},
                backgroundColor: '#10B981',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Predicted: ${context.raw}%`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Temperature & Humidity Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: {{ dates|safe }},
            datasets: [
                {
                    label: 'Temperature (Â°C)',
                    data: {{ temp_values|safe }},
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#EF4444',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Humidity (%)',
                    data: {{ humidity_values|safe }},
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#3B82F6',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            family: "'Poppins', sans-serif"
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#1F2937',
                    titleFont: {
                        size: 13,
                        family: "'Poppins', sans-serif",
                        weight: '600'
                    },
                    bodyColor: '#4B5563',
                    bodyFont: {
                        size: 12,
                        family: "'Poppins', sans-serif"
                    },
                    borderColor: '#E5E7EB',
                    borderWidth: 1,
                    padding: 12,
                    boxPadding: 4,
                    usePointStyle: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: {
                            size: 11,
                            family: "'Poppins', sans-serif"
                        },
                        padding: 8
                    },
                    border: {
                        dash: [4, 4]
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11,
                            family: "'Poppins', sans-serif"
                        },
                        padding: 8
                    }
                }
            },
            elements: {
                line: {
                    borderJoinStyle: 'round'
                }
            }
        }
    });
});
</script>
{% endblock %}
