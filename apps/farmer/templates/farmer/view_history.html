{% extends 'farmer/base.html' %}

{% block base_title %}View History{% endblock %}

{% block page_title %}View History{% endblock %}
{% block page_subtitle %}Track your file uploads and data history{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-lg font-semibold text-gray-900">Upload History</h3>
            <p class="text-sm text-gray-600 mt-1">Total: {{ total_files }} files ({{ csv_files }} CSV, {{ json_files }} JSON)</p>
        </div>
        <div class="flex space-x-2">
            <select id="file-type-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <option value="">All Files</option>
                <option value="csv">CSV Files</option>
                <option value="json">JSON Files</option>
            </select>
            <input type="date" id="date-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
            <button onclick="applyFilters()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors">
                Filter
            </button>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="files-table-body" class="bg-white divide-y divide-gray-200">
                {% if uploaded_files %}
                    {% for file in uploaded_files %}
                    <tr class="hover:bg-gray-50" data-file-id="{{ file.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas {% if file.file_type == 'csv' %}fa-file-csv text-green-500{% else %}fa-file-code text-blue-500{% endif %} mr-3"></i>
                                <span class="text-sm font-medium text-gray-900">{{ file.file_name }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ file.file_type|upper }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ file.get_file_size_mb }} MB</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ file.upload_date|date:"M d, Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if file.status == 'processed' %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Processed</span>
                            {% elif file.status == 'processing' %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Processing</span>
                            {% elif file.status == 'error' %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Error</span>
                            {% else %}
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Uploaded</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex space-x-2">
                                <button onclick="downloadFile('{{ file.id }}')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="deleteFile('{{ file.id }}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-folder-open text-4xl mb-4"></i>
                            <p class="text-lg font-medium">No files uploaded yet</p>
                            <p class="text-sm">Upload your first soil data file to get started</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date picker with current date
    document.getElementById('date-filter').valueAsDate = new Date();
});

function applyFilters() {
    const fileType = document.getElementById('file-type-filter').value;
    const date = document.getElementById('date-filter').value;
    
    // Reload the page with filter parameters
    window.location.href = `{% url 'farmer:view_history' %}?file_type=${fileType}&date=${date}`;
}

async function downloadFile(fileId) {
    try {
        const response = await fetch(`{% url 'farmer:download_file' %}?file_id=${fileId}`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `soil_data_${fileId}.${response.headers.get('Content-Type').includes('csv') ? 'csv' : 'json'}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        } else {
            showNotification('Failed to download file', 'error');
        }
    } catch (error) {
        showNotification('Error downloading file: ' + error.message, 'error');
    }
}

async function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) return;

    try {
        const response = await fetch(`{% url 'farmer:delete_file' %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ file_id: fileId })
        });

        if (response.ok) {
            const row = document.querySelector(`tr[data-file-id="${fileId}"]`);
            row.remove();
            showNotification('File deleted successfully', 'success');
        } else {
            showNotification('Failed to delete file', 'error');
        }
    } catch (error) {
        showNotification('Error deleting file: ' + error.message, 'error');
    }
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-500' : 'bg-green-500'
    } text-white`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
